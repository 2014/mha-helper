#!/bin/bash

# (c) 2013, Ovais Tariq <ovaistariq@gmail.com>
#
# This file is part of mha-helper
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

dead_master_host=""
conf=""

while [ $# -gt 0 ]
do
    case "$1" in
        -h | --help | -\?)
            # Call usage() function here @TODO
            exit 0 
            ;;
        -c | --conf)
            conf="$2"
            shift
            ;;
        --conf=*)
            conf=${1#*=}
            shift
            ;;
        -d | --dead-host)
            dead_master_host="$2"
            shift
            ;;
        --dead-host=*)
            dead_master_host=${1#*=}
            shift
            ;;
        --)
            shift
            break
            ;;
        -*)
            echo "WARN: Unknown option (ignored): $1" >&2
            shift
            ;;
        *)
            break
            ;;
    esac
done

if [[ -z $dead_master_host ]]
then
    echo "ERROR: option '--dead-host HOST' (hostname of dead master) not given. See --help" >&2
    exit 1
fi

if [[ -z "$conf" ]]
then
    echo "ERROR: option '--conf CONF' not given. See --help" >&2
    exit 1
fi

if [[ ! -e "$conf" ]]
then
    echo "ERROR: $conf does not exist"
    exit 1
fi

echo "/usr/bin/masterha_master_switch \
--conf=${conf} \
--master_state=dead \
--interactive=0 \
--ignore_last_failover \
--dead_master_host=${dead_master_host}"
